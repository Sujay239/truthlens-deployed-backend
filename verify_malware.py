import requests
import random
import string
import hashlib

# Configuration
BASE_URL = "http://127.0.0.1:8000"
USERNAME = "test_malware_user_" + "".join(random.choices(string.ascii_lowercase, k=5))
PASSWORD = "password123"

def verify_malware():
    # 1. Register/Login
    print(f"Authenticating as {USERNAME}...")
    auth_url = f"{BASE_URL}/auth/login"
    reg_url = f"{BASE_URL}/auth/register"
    
    requests.post(reg_url, json={"username": USERNAME, "password": PASSWORD, "email": f"{USERNAME}@example.com"})
    
    response = requests.post(auth_url, json={"username": USERNAME, "password": PASSWORD})
    if response.status_code != 200:
        print(f"Authentication failed: {response.text}")
        return

    token = response.json().get("access_token")
    headers = {"Authorization": f"Bearer {token}"}
    
    scan_url = f"{BASE_URL}/scan/malware"
    
    # 2. Test EICAR Test File (Standard Anti-Virus Test File)
    # The EICAR file is a safe file used to test AVs.
    eicar_string = b'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'
    print(f"\nScanning EICAR Test String (Should be Malicious)...")
    
    files = {'file': ('eicar.com', eicar_string)}
    resp_vuln = requests.post(scan_url, headers=headers, files=files)
    print(f"Response: {resp_vuln.json()}")

    # 3. Test Clean File
    print(f"\nScanning Clean Text File...")
    clean_bytes = b"This is a safe file. No virus here."
    files_safe = {'file': ('safe.txt', clean_bytes)}
    resp_safe = requests.post(scan_url, headers=headers, files=files_safe)
    print(f"Response: {resp_safe.json()}")

    # 4. Test URL
    print(f"\nScanning URL (google.com)...")
    resp_url = requests.post(scan_url, headers=headers, data={'url': 'http://google.com'})
    print(f"Response: {resp_url.json()}")
    
if __name__ == "__main__":
    verify_malware()
